// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Curry from "../../../../../node_modules/rescript/lib/es6/curry.js";
import * as React from "react";
import * as Wagmi from "wagmi";
import * as Js_exn from "../../../../../node_modules/rescript/lib/es6/js_exn.js";
import * as Js_dict from "../../../../../node_modules/rescript/lib/es6/js_dict.js";
import * as $$Promise from "../../../../../node_modules/@ryyppy/rescript-promise/src/Promise.js";
import * as AuthServer from "../../AuthServer.js";
import * as Belt_Array from "../../../../../node_modules/rescript/lib/es6/belt_Array.js";
import * as Caml_array from "../../../../../node_modules/rescript/lib/es6/caml_array.js";
import * as AdminButton from "../../components/AdminButton.js";
import * as Belt_Option from "../../../../../node_modules/rescript/lib/es6/belt_Option.js";
import * as Caml_option from "../../../../../node_modules/rescript/lib/es6/caml_option.js";
import * as Decode$Shared from "../../../../../node_modules/@brightidbot/shared/src/Decode.js";
import * as DiscordServer from "../../DiscordServer.js";
import * as SidebarToggle from "../../components/SidebarToggle.js";
import * as WebUtils_Gist from "../../utils/WebUtils_Gist.js";
import * as $$Node from "@remix-run/node";
import * as ReactHotToast from "react-hot-toast";
import ReactHotToast$1 from "react-hot-toast";
import * as React$1 from "@remix-run/react";
import * as SponsorshipsPopup from "../../components/SponsorshipsPopup.js";
import * as JsxRuntime from "react/jsx-runtime";
import * as Caml_js_exceptions from "../../../../../node_modules/rescript/lib/es6/caml_js_exceptions.js";
import * as DiscordLoginButton from "../../components/DiscordLoginButton.js";
import * as Guilds_AdminSubmit from "./admin/Guilds_AdminSubmit.js";
import * as Rainbowkit from "@rainbow-me/rainbowkit";

var Await = {};

async function loader(param) {
  var guildId = Belt_Option.getWithDefault(Js_dict.get(param.params, "guildId"), "");
  var maybeUser;
  var exit = 0;
  var data;
  try {
    data = await AuthServer.authenticator.isAuthenticated(param.request);
    exit = 1;
  }
  catch (raw_e){
    var e = Caml_js_exceptions.internalToOCamlException(raw_e);
    if (e.RE_EXN_ID === $$Promise.JsError) {
      maybeUser = undefined;
    } else {
      throw e;
    }
  }
  if (exit === 1) {
    maybeUser = (data == null) ? undefined : Caml_option.some(data);
  }
  if (maybeUser === undefined) {
    return {
            maybeUser: maybeUser,
            isAdmin: false,
            maybeDiscordGuild: Promise.resolve(undefined)
          };
  }
  try {
    var discordGuild = await DiscordServer.fetchDiscordGuildFromId(guildId);
    var userId = Caml_option.valFromOption(maybeUser).profile.id;
    var guildMember = await DiscordServer.fetchGuildMemberFromId(guildId, userId);
    var memberRoles = (guildMember == null) ? [] : guildMember.roles;
    var guildRoles;
    try {
      guildRoles = await DiscordServer.fetchGuildRoles(guildId);
    }
    catch (raw_exn){
      var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
      if (exn.RE_EXN_ID === $$Promise.JsError) {
        guildRoles = [];
      } else {
        throw exn;
      }
    }
    var isAdmin = DiscordServer.memberIsAdmin(guildRoles, memberRoles);
    var isOwner = (discordGuild == null) ? false : discordGuild.owner_id === userId;
    return $$Node.defer({
                maybeUser: maybeUser,
                isAdmin: isAdmin || isOwner,
                maybeDiscordGuild: Promise.resolve((discordGuild == null) ? undefined : Caml_option.some(discordGuild))
              });
  }
  catch (raw_e$1){
    var e$1 = Caml_js_exceptions.internalToOCamlException(raw_e$1);
    if (e$1.RE_EXN_ID === Js_exn.$$Error) {
      console.error(e$1._1);
      return {
              maybeUser: maybeUser,
              isAdmin: false,
              maybeDiscordGuild: Promise.resolve(undefined)
            };
    }
    throw e$1;
  }
}

async function action(param) {
  var request = param.request;
  var guildId = Belt_Option.getWithDefault(Js_dict.get(param.params, "guildId"), "");
  var exit = 0;
  var data;
  try {
    data = await AuthServer.authenticator.isAuthenticated(request);
    exit = 1;
  }
  catch (raw_exn){
    var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
    if (exn.RE_EXN_ID !== "JsError") {
      throw exn;
    }
    
  }
  exit === 1;
  var data$1 = await request.formData();
  var match = Guilds_AdminSubmit.Form.make(data$1);
  var config = WebUtils_Gist.makeGistConfig(process.env.GIST_ID, "guildData.json", process.env.GITHUB_ACCESS_TOKEN);
  var content = await WebUtils_Gist.ReadGist.content(config, Decode$Shared.Decode_Gist.brightIdGuilds);
  var entry = Js_dict.get(content, guildId);
  var prevEntry;
  if (entry !== undefined) {
    prevEntry = entry;
  } else {
    throw {
          RE_EXN_ID: Guilds_AdminSubmit.GuildDoesNotExist,
          _1: guildId,
          Error: new Error()
        };
  }
  var entry_role = prevEntry.role;
  var entry_name = prevEntry.name;
  var entry_inviteLink = prevEntry.inviteLink;
  var entry_roleId = prevEntry.roleId;
  var entry_sponsorshipAddress = match.sponsorshipAddress;
  var entry_sponsorshipAddressEth = prevEntry.sponsorshipAddressEth;
  var entry_usedSponsorships = prevEntry.usedSponsorships;
  var entry_assignedSponsorships = prevEntry.assignedSponsorships;
  var entry_premiumSponsorshipsUsed = prevEntry.premiumSponsorshipsUsed;
  var entry_premiumExpirationTimestamp = prevEntry.premiumExpirationTimestamp;
  var entry$1 = {
    role: entry_role,
    name: entry_name,
    inviteLink: entry_inviteLink,
    roleId: entry_roleId,
    sponsorshipAddress: entry_sponsorshipAddress,
    sponsorshipAddressEth: entry_sponsorshipAddressEth,
    usedSponsorships: entry_usedSponsorships,
    assignedSponsorships: entry_assignedSponsorships,
    premiumSponsorshipsUsed: entry_premiumSponsorshipsUsed,
    premiumExpirationTimestamp: entry_premiumExpirationTimestamp
  };
  var data$2;
  try {
    data$2 = await WebUtils_Gist.UpdateGist.updateEntry(content, guildId, entry$1, config);
  }
  catch (raw_e){
    var e = Caml_js_exceptions.internalToOCamlException(raw_e);
    if (e.RE_EXN_ID === "JsError") {
      return {
              TAG: /* Error */1,
              _0: {
                RE_EXN_ID: "JsError",
                _1: e._1
              }
            };
    }
    throw e;
  }
  return {
          TAG: /* Ok */0,
          _0: data$2
        };
}

var state = {
  maybeDiscordGuild: undefined,
  maybeBrightIdGuild: undefined,
  loading: true,
  submitting: false,
  oauthGuild: undefined
};

function reducer(state, action) {
  switch (action.TAG | 0) {
    case /* SetGuild */0 :
        return {
                maybeDiscordGuild: action._0,
                maybeBrightIdGuild: state.maybeBrightIdGuild,
                loading: state.loading,
                submitting: state.submitting,
                oauthGuild: state.oauthGuild
              };
    case /* SetBrightIdGuild */1 :
        return {
                maybeDiscordGuild: state.maybeDiscordGuild,
                maybeBrightIdGuild: action._0,
                loading: state.loading,
                submitting: state.submitting,
                oauthGuild: state.oauthGuild
              };
    case /* SetLoading */2 :
        return {
                maybeDiscordGuild: state.maybeDiscordGuild,
                maybeBrightIdGuild: state.maybeBrightIdGuild,
                loading: action._0,
                submitting: state.submitting,
                oauthGuild: state.oauthGuild
              };
    case /* SetSubmitting */3 :
        return {
                maybeDiscordGuild: state.maybeDiscordGuild,
                maybeBrightIdGuild: state.maybeBrightIdGuild,
                loading: state.loading,
                submitting: action._0,
                oauthGuild: state.oauthGuild
              };
    case /* SetOAuthGuild */4 :
        return {
                maybeDiscordGuild: state.maybeDiscordGuild,
                maybeBrightIdGuild: state.maybeBrightIdGuild,
                loading: state.loading,
                submitting: state.submitting,
                oauthGuild: action._0
              };
    
  }
}

function $$default(param) {
  var match = React$1.useParams();
  var guildId = match.guildId;
  var match$1 = React$1.useLoaderData();
  var isAdmin = match$1.isAdmin;
  var maybeUser = match$1.maybeUser;
  var discordGuild = React$1.useAsyncValue();
  var context = React$1.useOutletContext();
  var account = Wagmi.useAccount(undefined);
  var matches = React$1.useMatches();
  var match$2 = Caml_array.get(matches, matches.length - 1 | 0);
  var fetcher = React$1.useFetcher();
  var match$3 = React.useReducer(reducer, state);
  var dispatch = match$3[1];
  var getGuildName = discordGuild !== undefined ? discordGuild.name : "No Guild";
  Wagmi.useSignMessage({
        message: "I consent that the SP in this address is able to be used by members of " + getGuildName + " Discord Server",
        onError: (function (e) {
            var match = e.name;
            if (match === "ConnectorNotFoundError") {
              ReactHotToast$1.error("No wallet found", undefined);
              return ;
            }
            ReactHotToast$1.error(e.message, undefined);
          }),
        onSuccess: (function (param) {
            var options = {
              method: "post"
            };
            fetcher.submit({
                  sponsorshipAddress: account.address
                }, options);
          })
      });
  React.useEffect((function () {
          var match = fetcher.type;
          switch (match) {
            case "actionReload" :
                Curry._1(dispatch, {
                      TAG: /* SetSubmitting */3,
                      _0: false
                    });
                break;
            case "actionSubmission" :
                Curry._1(dispatch, {
                      TAG: /* SetSubmitting */3,
                      _0: true
                    });
                break;
            case "done" :
                var data = fetcher.data;
                if (data == null) {
                  Curry._1(dispatch, {
                        TAG: /* SetLoading */2,
                        _0: false
                      });
                } else {
                  Curry._1(dispatch, {
                        TAG: /* SetGuild */0,
                        _0: data.maybeDiscordGuild
                      });
                  Curry._1(dispatch, {
                        TAG: /* SetBrightIdGuild */1,
                        _0: data.maybeBrightIdGuild
                      });
                  Curry._1(dispatch, {
                        TAG: /* SetLoading */2,
                        _0: false
                      });
                }
                break;
            case "init" :
                fetcher.load("/guilds/" + guildId + "/Guilds_FetchGuild");
                Curry._1(dispatch, {
                      TAG: /* SetLoading */2,
                      _0: true
                    });
                break;
            default:
              
          }
        }), [fetcher]);
  React.useEffect((function () {
          var contextGuilds = context.guilds;
          var index = Belt_Array.getIndexBy(contextGuilds, (function (guild) {
                  return guild.id === guildId;
                }));
          if (index !== undefined) {
            Curry._1(dispatch, {
                  TAG: /* SetOAuthGuild */4,
                  _0: Belt_Array.get(contextGuilds, index)
                });
          }
          
        }), [context]);
  var guildHeader = JsxRuntime.jsx(React.Suspense, {
        children: Caml_option.some(JsxRuntime.jsx(React$1.Await, {
                  children: (function (discordGuild) {
                      return JsxRuntime.jsxs("div", {
                                  children: [
                                    JsxRuntime.jsx("img", {
                                          className: "rounded-full h-24",
                                          src: Belt_Option.getWithDefault(Belt_Option.map(discordGuild.icon, (function (icon) {
                                                      return "https://cdn.discordapp.com/icons/" + discordGuild.id + "/" + icon + ".png";
                                                    })), "")
                                        }),
                                    JsxRuntime.jsx("p", {
                                          children: discordGuild.name,
                                          className: "text-4xl font-bold text-white"
                                        }),
                                    isAdmin ? JsxRuntime.jsx(AdminButton.make, {
                                            guildId: discordGuild.id
                                          }) : JsxRuntime.jsx(JsxRuntime.Fragment, {})
                                  ],
                                  className: "flex gap-6 w-full justify-start items-center p-4"
                                });
                    }),
                  resolve: match$1.maybeDiscordGuild
                })),
        fallback: Caml_option.some(JsxRuntime.jsx("p", {
                  children: "Loading...",
                  className: "text-3xl text-white font-poppins p-4"
                }))
      });
  React.useEffect((function () {
          if (context.rateLimited) {
            ReactHotToast$1.error("The bot is being rate limited. Please try again later", undefined);
          }
          
        }), []);
  var showPopup = Belt_Option.getWithDefault(Belt_Array.get(Belt_Array.reverse(match$2.id.split("/")), 0), "") === "$guildId";
  return JsxRuntime.jsxs("div", {
              children: [
                JsxRuntime.jsx(ReactHotToast.Toaster, {}),
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsxs("header", {
                              children: [
                                JsxRuntime.jsx(SidebarToggle.make, {
                                      handleToggleSidebar: context.handleToggleSidebar,
                                      maybeUser: maybeUser
                                    }),
                                JsxRuntime.jsx("div", {
                                      children: JsxRuntime.jsx(Rainbowkit.ConnectButton, {
                                            className: "h-full"
                                          }),
                                      className: "flex flex-col md:flex-row gap-2 items-center justify-center"
                                    })
                              ],
                              className: "flex flex-row justify-between md:justify-end items-center m-4"
                            }),
                        maybeUser !== undefined ? JsxRuntime.jsxs(JsxRuntime.Fragment, {
                                children: [
                                  guildHeader,
                                  JsxRuntime.jsxs("div", {
                                        children: [
                                          JsxRuntime.jsx("section", {
                                                children: JsxRuntime.jsx(React$1.Outlet, {}),
                                                className: "width-full flex flex-col md:flex-row justify-around items-center w-full"
                                              }),
                                          showPopup ? JsxRuntime.jsx(SponsorshipsPopup.make, {}) : JsxRuntime.jsx(JsxRuntime.Fragment, {})
                                        ],
                                        className: "flex flex-1 flex-col  justify-around items-center text-center relative"
                                      })
                                ]
                              }) : JsxRuntime.jsxs("div", {
                                children: [
                                  JsxRuntime.jsx("p", {
                                        children: "Please login to continue",
                                        className: "text-3xl text-white font-poppins"
                                      }),
                                  JsxRuntime.jsx(DiscordLoginButton.make, {
                                        label: "Login To Discord"
                                      })
                                ],
                                className: "flex flex-col items-center justify-center h-full gap-4"
                              })
                      ],
                      className: "flex flex-col h-screen"
                    })
              ],
              className: "flex-1"
            });
}

export {
  Await ,
  loader ,
  action ,
  state ,
  reducer ,
  $$default ,
  $$default as default,
}
/* react Not a pure module */
